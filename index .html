<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Orange Card v8.1 - å…¨ç”»é¢è¡¨ç¤ºå¯¾å¿œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <style>
        :root {
            --bg: #0f1115;
            --card: #171a21;
            --text: #e7e7e7;
            --muted: #a8b0bf;
            --accent: #ff9800;
            --danger: #e91e63;
            --line: #2a2f3a;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .topbar {
            background: #11141b;
            border-bottom: 1px solid var(--line);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .topbar-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0.75rem 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            font-weight: 900;
            font-size: 1.1rem;
        }

        .nav {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .tab {
            background: transparent;
            border: 1px solid var(--line);
            color: var(--muted);
            padding: 0.45rem 0.75rem;
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .tab:hover {
            background: rgba(255, 152, 0, 0.1);
        }

        .tab.active {
            border-color: transparent;
            background: var(--accent);
            color: #111;
            font-weight: 850;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1rem;
        }

        .view.hidden {
            display: none !important;
        }

        .title {
            font-size: 1.35rem;
            margin: 0.2rem 0 1rem;
            font-weight: 700;
        }

        h2 {
            font-size: 1.1rem;
            margin: 0 0 0.75rem;
            font-weight: 700;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-banner {
            background: rgba(229, 57, 53, 0.15);
            border: 2px solid #e53935;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .info-banner strong {
            color: #ff6b6b;
        }

        .science-details {
            background: rgba(255, 152, 0, 0.08);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 0;
            margin: 1rem 0;
        }

        .science-details summary {
            padding: 1rem;
            cursor: pointer;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .science-details summary:hover {
            background: rgba(255, 152, 0, 0.1);
        }

        .science-details[open] summary {
            border-bottom: 1px solid var(--line);
        }

        .science-details-content {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            font-size: 0.9rem;
            font-family: 'Monaco', 'Courier New', monospace;
            overflow-x: auto;
        }

        .science-details-content pre {
            margin: 0;
            color: #90caf9;
            line-height: 1.5;
        }

        .brain-explanation {
            background: rgba(255, 152, 0, 0.05);
            border-left: 4px solid var(--accent);
            padding: 0.75rem;
            margin: 0.75rem 0;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .brain-explanation strong {
            color: var(--accent);
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            color: var(--muted);
            font-size: 0.95rem;
        }

        select, input[type="number"] {
            padding: 0.6rem 0.7rem;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #0d0f14;
            color: var(--text);
            min-width: 5rem;
            cursor: pointer;
            font-size: 0.95rem;
        }

        button {
            padding: 0.6rem 0.9rem;
            border-radius: 999px;
            border: none;
            background: var(--accent);
            color: #111;
            cursor: pointer;
            font-weight: 850;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        button:hover {
            background: #ff8c00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--line);
        }

        button.secondary:hover {
            background: rgba(255, 152, 0, 0.15);
            border-color: var(--accent);
        }

        button.danger {
            background: var(--danger);
            color: #fff;
        }

        button.danger:hover {
            background: #d81b60;
        }

        .row {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .muted {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .stage {
            margin-top: 1rem;
            position: relative;
            width: 100%;
            max-width: 720px;
            height: 360px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--line);
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            margin-right: auto;
        }

        .orange-card {
            width: 400px;
            height: 250px;
            background: linear-gradient(135deg, #ff9800 0%, #ff8c00 50%, #ff9800 100%);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 60px rgba(255, 152, 0, 0.8), 0 0 20px rgba(255, 100, 0, 0.6);
            z-index: 10;
        }

        .orange-card::before {
            content: '';
            position: absolute;
            width: 160px;
            height: 160px;
            background: #1e88e5;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
        }

        .orange-card::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #000;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 12;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
        }

        /* å…¨ç”»é¢è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .fullscreen-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 99999;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .fullscreen-overlay.show {
            visibility: visible !important;
            opacity: 1 !important;
        }

        .fullscreen-overlay.hidden {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .fullscreen-inner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            width: 100%;
            height: 100%;
        }

        .fullscreen-timer {
            font-size: 4rem;
            font-weight: 1000;
            color: var(--accent);
            text-shadow: 0 0 20px rgba(255, 152, 0, 0.8);
            font-family: 'Courier New', monospace;
            letter-spacing: 0.1em;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .fullscreen-label {
            font-size: 1.5rem;
            color: var(--accent);
            text-align: center;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fullscreen-instruction {
            position: absolute;
            bottom: 2rem;
            color: var(--muted);
            font-size: 1rem;
            text-align: center;
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 49%, 100% { opacity: 0.5; }
            50%, 99% { opacity: 1; }
        }

        .orange-card-fullscreen {
            width: 80vw;
            height: 60vh;
            max-width: 600px;
            max-height: 450px;
            background: linear-gradient(135deg, #ff9800 0%, #ff8c00 50%, #ff9800 100%);
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 100px rgba(255, 152, 0, 1), 0 0 40px rgba(255, 100, 0, 0.8);
            animation: cardEnter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes cardEnter {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .orange-card-fullscreen::before {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            background: #1e88e5;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
        }

        .orange-card-fullscreen::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #000;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 12;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.9);
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 99998;
            visibility: hidden;
            opacity: 0;
            transition: all 0.15s ease;
        }

        .overlay.show {
            visibility: visible !important;
            opacity: 1 !important;
        }

        .overlay.hidden {
            visibility: hidden !important;
            opacity: 0 !important;
            display: none !important;
        }

        .overlay-inner {
            text-align: center;
            max-width: 540px;
        }

        .big {
            font-size: 1.4rem;
            font-weight: 950;
            margin-bottom: 0.25rem;
        }

        .small {
            color: var(--muted);
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .timer {
            font-size: 2.2rem;
            font-weight: 1000;
            margin: 0.5rem 0 1rem;
            color: var(--accent);
        }

        .sharpness-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 99997;
            visibility: hidden;
            opacity: 0;
            transition: all 0.15s ease;
        }

        .sharpness-overlay.show {
            visibility: visible !important;
            opacity: 1 !important;
        }

        .sharpness-overlay.hidden {
            visibility: hidden !important;
            opacity: 0 !important;
            display: none !important;
        }

        .sharpness-inner {
            text-align: center;
            max-width: 540px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 2rem;
            z-index: 100000;
        }

        .sharpness-title {
            font-size: 1.3rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
        }

        .sharpness-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .sharpness-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--line);
            border-radius: 12px;
            transition: all 0.2s;
            width: 100%;
            max-width: 300px;
        }

        .sharpness-option:hover {
            border-color: var(--accent);
            background: rgba(255, 152, 0, 0.05);
        }

        .sharpness-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .sharpness-option.selected {
            border-color: var(--accent);
            background: rgba(255, 152, 0, 0.1);
        }

        .sharpness-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            flex-wrap: wrap;
        }

        .brain-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: center;
            margin: 1.5rem 0;
        }

        .brain-visual {
            display: flex;
            justify-content: center;
            grid-column: 1 / -1;
        }

        .brain-visual svg {
            max-width: 100%;
            height: auto;
        }

        .gauge-bar {
            background: var(--line);
            border-radius: 8px;
            overflow: hidden;
            height: 24px;
            position: relative;
            margin-bottom: 8px;
        }

        .gauge-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .gauge-label {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .quality-score {
            background: rgba(255, 152, 0, 0.1);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            grid-column: 1 / -1;
        }

        .score-val {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #ffb300, #ff9800, #ff6b00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-label {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .kpi {
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 0.55rem 0.7rem;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(0,0,0,0.15);
        }

        .kpi-val {
            color: var(--text);
            font-weight: 950;
        }

        .score-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        .score-badge.excellent {
            background: rgba(46, 125, 50, 0.3);
            color: #66bb6a;
        }

        .score-badge.good {
            background: rgba(255, 179, 0, 0.3);
            color: #ffc107;
        }

        .score-badge.improving {
            background: rgba(229, 57, 53, 0.3);
            color: #ef5350;
        }

        @media (max-width: 900px) {
            .brain-section {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 600px) {
            .topbar-inner {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav {
                width: 100%;
            }

            .stage {
                width: 100%;
            }

            .brain-section {
                gap: 0.75rem;
            }

            .orange-card {
                width: 300px;
                height: 200px;
            }

            .fullscreen-timer {
                font-size: 3rem;
            }

            .fullscreen-label {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="topbar-inner">
            <div class="brand">ğŸŸ  Orange Card v8.1</div>
            <nav class="nav">
                <button class="tab active" data-tab="training">ã‚ªãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</button>
                <button class="tab" data-tab="dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
                <button class="tab" data-tab="settings">è¨­å®š</button>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- ç§‘å­¦çš„æ ¹æ‹ ãƒãƒŠãƒ¼ -->
        <div class="info-banner">
            <strong>âš ï¸ ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</strong><br>
            â€¢ è¦–è¦šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¯è„³ç§‘å­¦ç ”ç©¶ã«ã‚ˆã‚Šæ ¹æ‹ ãŒã‚ã‚Šã¾ã™<br>
            â€¢ ã“ã®ã‚¢ãƒ—ãƒªã®ã€Œå“è³ªã‚¹ã‚³ã‚¢ã€ã¨è„³é ˜åŸŸ%ã¯æ¨å®šå€¤ã§ã™<br>
            â€¢ å®Ÿéš›ã®è„³æ´»å‹•ï¼ˆfMRIç­‰ï¼‰ã‚’è¨ˆæ¸¬ã—ãŸã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“<br>
            â€¢ å®šæœŸçš„ãªçœ¼ç§‘æ¤œè¨ºã‚’ãŠå‹§ã‚ã—ã¾ã™
        </div>

        <!-- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° -->
        <section id="training" class="view">
            <h1 class="title">ğŸŸ  ã‚ªãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>

            <div class="card">
                <div class="row">
                    <label>
                        æ³¨è¦–æ™‚é–“ï¼ˆç§’ï¼‰
                        <select id="stareSec">
                            <option value="3">3ç§’</option>
                            <option value="5">5ç§’</option>
                            <option value="10" selected>10ç§’</option>
                            <option value="15">15ç§’</option>
                            <option value="20">20ç§’</option>
                            <option value="30">30ç§’</option>
                            <option value="60">60ç§’</option>
                        </select>
                    </label>
                    <button id="startBtn" onclick="handleStartClick()">é–‹å§‹</button>
                </div>
            </div>

            <!-- è¨ˆç®—å¼ã®èª¬æ˜ -->
            <details class="science-details">
                <summary>ğŸ”¬ ã‚¹ã‚³ã‚¢ã¯ã©ã†è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ</summary>
                <div class="science-details-content">
                    <pre>ã€å“è³ªã‚¹ã‚³ã‚¢è¨ˆç®—å¼ã€‘ï¼ˆv8.0æ”¹å–„ç‰ˆï¼‰

è¦–è¦šè² è· = min(100, æ®‹åƒæ™‚é–“ç§’ Ã— 10)
  â””â”€ æ®‹åƒãŒé•·ã„ã»ã©è¦–è¦šé‡ã®æ´»å‹•åº¦ãŒé«˜ã„

èªçŸ¥è² è· = min(100, æ³¨è¦–æ™‚é–“ç§’ Ã— 3)
  â””â”€ æ³¨è¦–ãŒé•·ã„ã»ã©å‰é ­è‘‰ã®æ³¨æ„åˆ¶å¾¡ãŒé«˜ã„

æ™‚é–“çµ±åˆ = min(100, log(æ³¨è¦–Ã—æ®‹åƒ+1) Ã— 15)
  â””â”€ æ³¨è¦–ã¨æ®‹åƒã®æ™‚é–“çš„çµ±åˆãŒå´é ­è‘‰ã‚’æ´»æ€§åŒ–

å“è³ªã‚¹ã‚³ã‚¢ = (è¦–è¦šè² è· + èªçŸ¥è² è· + æ™‚é–“çµ±åˆ) / 3

ã€ç¥çµŒç§‘å­¦çš„æ ¹æ‹ ã€‘
âœ“ è¦–è¦šåˆºæ¿€â†’è¦–è¦šé‡æ´»æ€§åŒ–: fMRIç ”ç©¶ã§ç¢ºèª
âœ“ çœ¼çƒé‹å‹•å­¦ç¿’â†’å°è„³å¯å¡‘åŒ–: 2024å¹´æ±åŒ—å¤§å­¦ç ”ç©¶
âœ“ è„³è¡€ç®¡é‹å‹•ã®å¢—å¹…: ä½å‘¨æ³¢åˆºæ¿€ã§å®Ÿè¨¼

ã€æ³¨æ„ã€‘
âš  è„³é ˜åŸŸã®%å€¤ã¯æ¨å®šå€¤ã§ã™
âš  å®Ÿæ¸¬ã®è„³ç”»åƒã§ã¯ã‚ã‚Šã¾ã›ã‚“
âš  ç›¸å¯¾çš„ãªæ´»å‹•åº¦ã®æŒ‡æ¨™ã§ã™
                    </pre>
                </div>
            </details>

            <div class="brain-explanation">
                <strong>ğŸ’¡ è„³é ˜åŸŸã«ã¤ã„ã¦</strong><br>
                å¾Œé ­è‘‰: è‰²ãƒ»å½¢ãƒ»å‹•ããªã©è¦–è¦šæƒ…å ±ã®åŸºæœ¬å‡¦ç†<br>
                å‰é ­è‘‰: æ³¨æ„åŠ›ãƒ»é›†ä¸­åŠ›ã®ç¶­æŒã¨åˆ¶å¾¡<br>
                é ­é ‚è‘‰: ç©ºé–“èªè­˜ãƒ»å¥¥è¡ŒãçŸ¥è¦š<br>
                å´é ­è‘‰: è¨˜æ†¶å½¢æˆãƒ»è¦–è¦šæƒ…å ±ã®çµ±åˆä¿å­˜<br>
                å°è„³: çœ¼çƒé‹å‹•ã®å­¦ç¿’ã¨å”èª¿
            </div>

            <div class="stage" id="stage" style="display: none;">
                <div class="orange-card" id="orangeCard"></div>
            </div>

            <!-- å…¨ç”»é¢ã‚ªãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
            <div id="fullscreenOverlay" class="fullscreen-overlay">
                <div class="fullscreen-inner">
                    <div class="orange-card-fullscreen" id="orangeCardFullscreen"></div>
                    <div class="fullscreen-timer" id="fullscreenTimer">10</div>
                    <div class="fullscreen-label">ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‚ã¦ãã ã•ã„</div>
                    <div class="fullscreen-instruction">ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ®‹åƒç¢ºèªã«é€²ã‚€</div>
                </div>
            </div>

            <div id="afterImageOverlay" class="overlay">
                <div class="overlay-inner">
                    <div class="big">æ®‹åƒã‚’è¦‹ã¦ãã ã•ã„</div>
                    <div class="small">ã‚ªãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‚ãŸå¾Œã®æ®‹åƒãŒã©ã®ãã‚‰ã„è¦‹ãˆã¦ã„ã¾ã™ã‹ï¼Ÿ</div>
                    <div class="timer"><span id="afterSec">0.0</span>ç§’</div>
                    <div class="small">ã‚¯ãƒªãƒƒã‚¯ã§çµ‚äº†</div>
                </div>
            </div>

            <div id="sharpnessOverlay" class="sharpness-overlay">
                <div class="sharpness-inner">
                    <div class="sharpness-title">æ®‹åƒã®é®®æ˜ã•ã‚’é¸æŠ</div>
                    <div class="sharpness-options">
                        <label class="sharpness-option">
                            <input type="radio" name="sharpness" value="3" checked>
                            <span>éå¸¸ã«é®®æ˜ï¼ˆãƒ¬ãƒ™ãƒ«3ï¼‰</span>
                        </label>
                        <label class="sharpness-option">
                            <input type="radio" name="sharpness" value="2">
                            <span>ä¸­ç¨‹åº¦ï¼ˆãƒ¬ãƒ™ãƒ«2ï¼‰</span>
                        </label>
                        <label class="sharpness-option">
                            <input type="radio" name="sharpness" value="1">
                            <span>ã‹ã™ã‹ï¼ˆãƒ¬ãƒ™ãƒ«1ï¼‰</span>
                        </label>
                    </div>
                    <div class="sharpness-buttons">
                        <button id="confirmBtn" onclick="handleConfirmClick()">ç¢ºå®š</button>
                        <button id="retryBtn" class="secondary" onclick="handleRetryClick()">ã‚„ã‚Šç›´ã™</button>
                    </div>
                </div>
            </div>

            <div class="card" id="resultCard" style="display: none;">
                <h3 style="margin: 0 0 0.5rem 0;">ğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœ</h3>
                <div id="resultText" style="color: var(--muted); font-size: 0.9rem; line-height: 1.6;"></div>
            </div>

            <div class="card">
                <h2>è„³æ´»å‹•ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«</h2>
                <div id="sessionHint" class="muted" style="margin-bottom: 1rem;">
                    <strong>ğŸ’¡ ä½¿ã„æ–¹ï¼š</strong>
                    ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚ãªãŸã®è„³æ´»å‹•ã®æ¨å®šåº¦ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                    ã“ã‚Œã¯ã‚¢ãƒ—ãƒªãŒè¨ˆç®—ã—ãŸç›¸å¯¾çš„ãªæ´»å‹•æŒ‡æ¨™ã§ã‚ã‚Šã€å®Ÿæ¸¬ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                </div>

                <div class="brain-visual">
                    <svg id="brainSvg" viewBox="0 0 800 420" role="img" aria-label="è„³æ´»å‹•ãƒãƒƒãƒ—" style="background: transparent;">
                        <defs>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>

                        <!-- å‰é ­è‘‰ -->
                        <path id="lobeFrontal" class="lobe" d="M150,120 Q165,105 225,110 Q255,120 255,210 Q248,225 210,232 Q165,225 150,195 Z" stroke="#fff" stroke-width="2" fill="#2e7d32" opacity="0.8"/>
                        <text id="pctFrontalText" x="195" y="180" fill="#fff" font-size="18" font-weight="700" text-anchor="middle" pointer-events="none">-</text>
                        <text x="195" y="260" fill="#e7e7e7" font-size="12" text-anchor="middle" pointer-events="none">å‰é ­è‘‰</text>
                        <text x="195" y="275" fill="#a8b0bf" font-size="10" text-anchor="middle" pointer-events="none">æ³¨æ„åˆ¶å¾¡</text>

                        <!-- é ­é ‚è‘‰ -->
                        <path id="lobeParietal" class="lobe" d="M255,110 Q310,95 420,105 Q450,120 435,210 Q405,225 315,220 Q260,215 255,150 Z" stroke="#fff" stroke-width="2" fill="#ffb300" opacity="0.8"/>
                        <text id="pctParietalText" x="350" y="160" fill="#fff" font-size="18" font-weight="700" text-anchor="middle" pointer-events="none">-</text>
                        <text x="350" y="85" fill="#e7e7e7" font-size="12" font-weight="700" text-anchor="middle" pointer-events="none">é ­é ‚è‘‰</text>
                        <text x="350" y="100" fill="#e7e7e7" font-size="10" text-anchor="middle" pointer-events="none">ç©ºé–“èªè­˜</text>

                        <!-- å´é ­è‘‰ -->
                        <path id="lobeTemporal" class="lobe" d="M225,210 Q255,235 330,250 Q360,260 360,320 Q330,345 270,335 Q225,320 225,270 Z" stroke="#fff" stroke-width="2" fill="#e53935" opacity="0.8"/>
                        <text id="pctTemporalText" x="295" y="285" fill="#fff" font-size="18" font-weight="700" text-anchor="middle" pointer-events="none">-</text>
                        <text x="295" y="375" fill="#e7e7e7" font-size="12" text-anchor="middle" pointer-events="none">å´é ­è‘‰</text>
                        <text x="295" y="390" fill="#a8b0bf" font-size="10" text-anchor="middle" pointer-events="none">è¨˜æ†¶å½¢æˆ</text>

                        <!-- å¾Œé ­è‘‰ -->
                        <path id="lobeOccipital" class="lobe" d="M435,105 Q500,120 545,150 Q570,190 545,280 Q500,315 435,305 Q435,200 435,150 Z" stroke="#fff" stroke-width="2" fill="#0078d4" opacity="0.8"/>
                        <text id="pctOccipitalText" x="500" y="215" fill="#fff" font-size="18" font-weight="700" text-anchor="middle" pointer-events="none">-</text>
                        <text x="500" y="260" fill="#e7e7e7" font-size="12" text-anchor="middle" pointer-events="none">å¾Œé ­è‘‰</text>
                        <text x="500" y="275" fill="#a8b0bf" font-size="10" text-anchor="middle" pointer-events="none">è¦–è¦šå‡¦ç†</text>
                    </svg>
                </div>

                <div style="margin-top: 1.5rem;">
                    <div class="gauge-label">ğŸ“Š è¦–è¦šè² è·</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" id="gaugeVisual" style="width: 0; background: linear-gradient(90deg, #0078d4, #2e7d32, #ffb300, #e53935);">
                            <span id="gaugeVisualText">-</span>
                        </div>
                    </div>

                    <div class="gauge-label">ğŸ§  èªçŸ¥è² è·</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" id="gaugeCog" style="width: 0; background: linear-gradient(90deg, #2e7d32, #ffb300, #ff8c00);">
                            <span id="gaugeCogText">-</span>
                        </div>
                    </div>

                    <div class="gauge-label">â±ï¸ æ™‚é–“çµ±åˆ</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--text);">
                        <span id="temporalVal">-</span>
                    </div>
                </div>

                <div class="quality-score">
                    <div class="score-val" id="qualityScore">-</div>
                    <div class="score-label" id="qualityLabel">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div>
                </div>
            </div>
        </section>

        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <section id="dashboard" class="view hidden">
            <h1 class="title">ğŸ“Š ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµ±è¨ˆ</h1>

            <div class="card">
                <div class="row">
                    <div class="kpi">
                        <span>æœ¬æ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³</span>
                        <span class="kpi-val" id="todayCount">0</span>
                    </div>
                    <div class="kpi">
                        <span>ç´¯è¨ˆã‚»ãƒƒã‚·ãƒ§ãƒ³</span>
                        <span class="kpi-val" id="totalCount">0</span>
                    </div>
                    <div class="kpi">
                        <span>å¹³å‡æ®‹åƒæ™‚é–“</span>
                        <span class="kpi-val" id="avgAfterImage">-</span>
                        <span class="score-badge" id="avgBadge"></span>
                    </div>
                    <div class="kpi">
                        <span>å®‰å®šæ€§</span>
                        <span class="kpi-val" id="stability">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>æ®‹åƒæ™‚é–“ã®æ¨ç§»</h2>
                <canvas id="afterImageChart" style="max-height: 300px; margin-bottom: 1rem;"></canvas>
            </div>

            <div class="card">
                <h2>é®®æ˜åº¦ã®åˆ†å¸ƒ</h2>
                <canvas id="sharpnessChart" style="max-height: 250px; margin-bottom: 1rem;"></canvas>
            </div>

            <div class="card">
                <h2>æœ€è¿‘ã®10ã‚»ãƒƒã‚·ãƒ§ãƒ³</h2>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--line);">
                                <th style="padding: 0.5rem; text-align: left;">æ™‚åˆ»</th>
                                <th style="padding: 0.5rem; text-align: left;">æ³¨è¦–(ç§’)</th>
                                <th style="padding: 0.5rem; text-align: left;">æ®‹åƒ(ç§’)</th>
                                <th style="padding: 0.5rem; text-align: left;">é®®æ˜åº¦</th>
                            </tr>
                        </thead>
                        <tbody id="recentTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- è¨­å®š -->
        <section id="settings" class="view hidden">
            <h1 class="title">âš™ï¸ è¨­å®š</h1>

            <div class="card">
                <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <div class="row">
                    <button id="backupBtn" onclick="handleBackupClick()">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <label style="cursor: pointer;">
                        ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        <input id="importFile" type="file" accept="application/json" style="display: none;">
                    </label>
                    <button id="deleteBtn" class="danger" onclick="handleDeleteClick()">ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                </div>
            </div>

            <div class="card">
                <h2>ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h2>
                <p class="muted">
                    <strong>Orange Card v8.1</strong> - å…¨ç”»é¢è¡¨ç¤ºå¯¾å¿œç‰ˆ<br>
                    <br>
                    ã‚ªãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã¸ã®æ³¨è¦–ã¨æ®‹åƒèªè­˜ã«ã‚ˆã‚Šã€è„³ã®è¤‡æ•°é ˜åŸŸã‚’æ´»æ€§åŒ–ã•ã›ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¢ãƒ—ãƒªã§ã™ã€‚<br>
                    <br>
                    <strong>åŸºç¤ã¨ãªã‚‹ç§‘å­¦çš„æ ¹æ‹ ï¼š</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                        <li>è¦–è¦šåˆºæ¿€ã«ã‚ˆã‚‹è„³æ´»å‹•ä¿ƒé€²ï¼ˆfMRIç ”ç©¶ï¼‰</li>
                        <li>çœ¼çƒé‹å‹•å­¦ç¿’ã«ã‚ˆã‚‹å°è„³å¯å¡‘åŒ–ï¼ˆæ±åŒ—å¤§å­¦2024å¹´ç ”ç©¶ï¼‰</li>
                        <li>è„³è¡€ç®¡é‹å‹•ã®å‘¨æœŸçš„æ´»æ€§åŒ–ï¼ˆãƒã‚½ãƒˆãƒ¬ç†è«–ï¼‰</li>
                        <li>ã‚·ãƒŠãƒ—ã‚¹å¯å¡‘æ€§ã«ã‚ˆã‚‹ç¥çµŒå›è·¯å†ç·¨</li>
                    </ul>
                    <br>
                    <strong>v8.1 æ”¹å–„ï¼š</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                        <li>é–‹å§‹ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«å…¨ç”»é¢è¡¨ç¤º</li>
                        <li>å¤§ããªã‚ªãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰è¡¨ç¤º</li>
                        <li>ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã§é–‹å§‹æ™‚åˆ»ã‚’æ˜ç¢ºã«</li>
                    </ul>
                    <br>
                    <strong>âš ï¸ é‡è¦ãªæ³¨æ„ï¼š</strong><br>
                    â€¢ ã“ã®ã‚¢ãƒ—ãƒªã®ã€Œå“è³ªã‚¹ã‚³ã‚¢ã€ã¨è„³é ˜åŸŸ%ã¯æ¨å®šå€¤ã§ã™<br>
                    â€¢ fMRIç­‰ã®è„³ç”»åƒã‚’å®Ÿæ¸¬ã—ãŸã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“<br>
                    â€¢ åŒ»å­¦çš„è¨ºæ–­ã«ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“<br>
                    â€¢ å®šæœŸçš„ãªçœ¼ç§‘æ¤œè¨ºã‚’ãŠå‹§ã‚ã—ã¾ã™
                </p>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        'use strict';

        let sessions = [];
        let stareTimer = null;
        let afterTimer = null;
        let afterStart = null;
        let selectedSharpness = 3;
        let isTraining = false;
        let currentSession = null;
        let afterImageChartInstance = null;
        let sharpnessChartInstance = null;
        let countdownTimer = null;

        window.addEventListener('load', function() {
            initApp();
        });

        function initApp() {
            initTabs();
            initSharpnessListeners();
            loadSessions();
            refreshDashboard();
        }

        function initTabs() {
            const tabs = document.querySelectorAll('[data-tab]');
            tabs.forEach(tab => {
                tab.onclick = function(e) {
                    e.preventDefault();
                    const tabName = this.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                    document.getElementById(tabName).classList.remove('hidden');
                    if (tabName === 'dashboard') refreshDashboard();
                };
            });
        }

        function initSharpnessListeners() {
            const radios = document.querySelectorAll('input[name="sharpness"]');
            radios.forEach(radio => {
                radio.onchange = function() {
                    selectedSharpness = parseInt(this.value);
                    document.querySelectorAll('.sharpness-option').forEach(opt => opt.classList.remove('selected'));
                    this.parentElement.classList.add('selected');
                };
            });
        }

        function handleStartClick() {
            if (isTraining) return;
            if (stareTimer !== null) clearTimeout(stareTimer);
            if (afterTimer !== null) clearInterval(afterTimer);
            if (countdownTimer !== null) clearInterval(countdownTimer);
            afterStart = null;
            isTraining = true;
            document.getElementById('startBtn').disabled = true;

            const stareSec = parseInt(document.getElementById('stareSec').value);

            // å…¨ç”»é¢è¡¨ç¤ºã‚’é–‹å§‹
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('show');

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹
            let remaining = stareSec;
            document.getElementById('fullscreenTimer').textContent = remaining;

            countdownTimer = setInterval(() => {
                remaining--;
                document.getElementById('fullscreenTimer').textContent = remaining;

                if (remaining <= 0) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    startAfterImage();
                }
            }, 1000);

            document.getElementById('afterImageOverlay').classList.remove('show');
            document.getElementById('afterImageOverlay').classList.add('hidden');
            document.getElementById('sharpnessOverlay').classList.remove('show');
            document.getElementById('sharpnessOverlay').classList.add('hidden');
        }

        function startAfterImage() {
            // å…¨ç”»é¢ã‚ªãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.remove('show');
            overlay.classList.add('hidden');

            afterStart = Date.now();
            const afterOverlay = document.getElementById('afterImageOverlay');
            afterOverlay.classList.remove('hidden');
            afterOverlay.classList.add('show');

            if (afterTimer !== null) clearInterval(afterTimer);
            afterTimer = setInterval(() => {
                if (afterStart === null) return;
                const elapsed = (Date.now() - afterStart) / 1000;
                document.getElementById('afterSec').textContent = elapsed.toFixed(1);
            }, 100);

            // ã‚¯ãƒªãƒƒã‚¯ã§çµ‚äº†
            const clickHandler = () => {
                endAfterImage();
                document.removeEventListener('click', clickHandler);
            };
            document.addEventListener('click', clickHandler);
        }

        function endAfterImage() {
            if (afterStart === null) return;
            if (afterTimer !== null) clearInterval(afterTimer);
            afterTimer = null;

            const afterSec = (Date.now() - afterStart) / 1000;
            afterStart = null;

            const overlay = document.getElementById('afterImageOverlay');
            overlay.classList.remove('show');
            overlay.classList.add('hidden');

            setTimeout(() => showSharpnessSelection(parseInt(document.getElementById('stareSec').value), afterSec), 150);
        }

        function showSharpnessSelection(stareSec, afterSec) {
            const radios = document.querySelectorAll('input[name="sharpness"]');
            radios.forEach(r => {
                if (r.value === '3') {
                    r.checked = true;
                    r.parentElement.classList.add('selected');
                } else {
                    r.parentElement.classList.remove('selected');
                }
            });
            selectedSharpness = 3;

            currentSession = { stareSec, afterSec };
            const overlay = document.getElementById('sharpnessOverlay');
            overlay.classList.add('show');
            overlay.classList.remove('hidden');
        }

        function handleConfirmClick() {
            if (!currentSession) return;

            const session = currentSession;
            session.sharpness = selectedSharpness;
            session.timestamp = new Date().toISOString();

            sessions.push(session);

            try {
                const json = JSON.stringify(sessions);
                if (json.length > 5242880) {
                    sessions = sessions.slice(-100);
                    localStorage.setItem('orangeCardSessions', JSON.stringify(sessions));
                } else {
                    localStorage.setItem('orangeCardSessions', json);
                }
            } catch (e) {
                console.error('v8.1 LocalStorage error', e);
                alert('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼');
            }

            document.getElementById('sharpnessOverlay').classList.remove('show');
            document.getElementById('sharpnessOverlay').classList.add('hidden');
            showResult(session);

            updateBrainVisualization(session);

            setTimeout(() => {
                isTraining = false;
                document.getElementById('startBtn').disabled = false;
                currentSession = null;
            }, 1000);
        }

        function handleRetryClick() {
            document.getElementById('sharpnessOverlay').classList.remove('show');
            document.getElementById('sharpnessOverlay').classList.add('hidden');
            isTraining = false;
            document.getElementById('startBtn').disabled = false;
            currentSession = null;
        }

        function showResult(session) {
            const sharpnessText = ['', 'ã‹ã™ã‹', 'ä¸­ç¨‹åº¦', 'éå¸¸ã«é®®æ˜'][session.sharpness];
            const date = new Date(session.timestamp);
            const resultText = document.getElementById('resultText');
            resultText.innerHTML = `
                <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†</strong><br>
                æ³¨è¦–æ™‚é–“: ${session.stareSec}ç§’<br>
                æ®‹åƒæ™‚é–“: ${session.afterSec.toFixed(2)}ç§’<br>
                é®®æ˜åº¦: ${sharpnessText}<br>
                æ™‚åˆ»: ${date.toLocaleTimeString('ja-JP')}
            `;

            const resultCard = document.getElementById('resultCard');
            resultCard.style.display = 'block';
            document.getElementById('sessionHint').style.display = 'none';

            setTimeout(() => {
                resultCard.style.display = 'none';
            }, 5000);
        }

        function updateBrainVisualization(session) {
            const stareSec = session.stareSec;
            const afterSec = session.afterSec;
            const sharpness = session.sharpness;

            // æ”¹å–„ç‰ˆè¨ˆç®—å¼ï¼ˆè„³ç§‘å­¦çš„æ ¹æ‹ ã‚’å¼·åŒ–ï¼‰
            const visualIntensity = Math.min(100, (afterSec / 10) * 100);
            const cogLoad = Math.min(100, (stareSec / 30) * 100);
            const temporalIntegration = Math.min(100, Math.log(stareSec + afterSec + 1) * 20);

            const totalLoad = visualIntensity + cogLoad + temporalIntegration;
            const occipital = (visualIntensity / totalLoad) * 100;
            const frontal = (cogLoad / totalLoad) * 100;
            const parietal = (stareSec / 30) * 100;
            const temporal = (temporalIntegration / totalLoad) * 100;

            const qualityScore = Math.round((visualIntensity + cogLoad + temporalIntegration) / 3);

            document.getElementById('pctOccipitalText').textContent = Math.round(occipital);
            document.getElementById('pctFrontalText').textContent = Math.round(frontal);
            document.getElementById('pctParietalText').textContent = Math.round(parietal);
            document.getElementById('pctTemporalText').textContent = Math.round(temporal);

            document.getElementById('gaugeVisual').style.width = Math.min(100, (visualIntensity / 1)) + '%';
            document.getElementById('gaugeVisualText').textContent = Math.round(visualIntensity);

            document.getElementById('gaugeCog').style.width = Math.min(100, (cogLoad / 1)) + '%';
            document.getElementById('gaugeCogText').textContent = Math.round(cogLoad);

            document.getElementById('temporalVal').textContent = temporalIntegration.toFixed(1);

            document.getElementById('qualityScore').textContent = qualityScore;

            const qualityLabel = document.getElementById('qualityLabel');
            if (qualityScore >= 75) {
                qualityLabel.textContent = 'å„ªç§€ - é«˜ã„è„³æ´»å‹•ãƒ¬ãƒ™ãƒ«';
                qualityLabel.style.color = '#66bb6a';
            } else if (qualityScore >= 50) {
                qualityLabel.textContent = 'è‰¯å¥½ - é †èª¿ã«é€²è¡Œä¸­';
                qualityLabel.style.color = '#ffc107';
            } else {
                qualityLabel.textContent = 'æ”¹å–„ä¸­ - ç¶™ç¶šã§ã•ã‚‰ã«å‘ä¸Š';
                qualityLabel.style.color = '#ef5350';
            }
        }

        function refreshDashboard() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todaySessions = sessions.filter(s => {
                const sessionDate = new Date(s.timestamp);
                sessionDate.setHours(0, 0, 0, 0);
                return sessionDate.getTime() === today.getTime();
            });

            document.getElementById('todayCount').textContent = todaySessions.length;
            document.getElementById('totalCount').textContent = sessions.length;

            if (sessions.length > 0) {
                const afterValues = sessions.map(s => s.afterSec);
                const avgAfter = afterValues.reduce((sum, val) => sum + val, 0) / afterValues.length;
                const variance = afterValues.reduce((sum, val) => sum + Math.pow(val - avgAfter, 2), 0) / afterValues.length;
                const stdDev = Math.sqrt(variance);

                document.getElementById('avgAfterImage').textContent = avgAfter.toFixed(2) + 'ç§’';

                // è©•ä¾¡ãƒãƒƒã‚¸
                const badge = document.getElementById('avgBadge');
                if (avgAfter >= 8) {
                    badge.textContent = 'å„ªç§€';
                    badge.className = 'score-badge excellent';
                } else if (avgAfter >= 5) {
                    badge.textContent = 'è‰¯å¥½';
                    badge.className = 'score-badge good';
                } else {
                    badge.textContent = 'æ”¹å–„ä¸­';
                    badge.className = 'score-badge improving';
                }

                const stability = stdDev < avgAfter * 0.3 ? 'å®‰å®š' : 'å¤‰å‹•ä¸­';
                document.getElementById('stability').textContent = `${stability} (Ïƒ=${stdDev.toFixed(2)})`;
            } else {
                document.getElementById('avgAfterImage').textContent = '-';
                document.getElementById('stability').textContent = '-';
                document.getElementById('avgBadge').textContent = '';
            }

            const recentTable = document.getElementById('recentTable');
            recentTable.innerHTML = '';
            const recent = sessions.slice(-10).reverse();
            recent.forEach(s => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--line)';
                const date = new Date(s.timestamp);
                const sharpnessText = ['', 'ã‹ã™ã‹', 'ä¸­ç¨‹åº¦', 'éå¸¸ã«é®®æ˜'][s.sharpness];
                row.innerHTML = `
                    <td style="padding: 0.5rem;">${date.toLocaleTimeString('ja-JP')}</td>
                    <td style="padding: 0.5rem;">${s.stareSec}</td>
                    <td style="padding: 0.5rem;">${s.afterSec.toFixed(2)}</td>
                    <td style="padding: 0.5rem;">${sharpnessText}</td>
                `;
                recentTable.appendChild(row);
            });

            updateCharts();
        }

        function updateCharts() {
            if (sessions.length === 0) return;

            const last20 = sessions.slice(-20);
            const labels = last20.map((s, i) => i + 1);
            const afterImageData = last20.map(s => parseFloat(s.afterSec.toFixed(2)));

            const ctx1 = document.getElementById('afterImageChart').getContext('2d');
            if (afterImageChartInstance) {
                afterImageChartInstance.data.labels = labels;
                afterImageChartInstance.data.datasets[0].data = afterImageData;
                afterImageChartInstance.update();
            } else {
                afterImageChartInstance = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ®‹åƒæ™‚é–“ï¼ˆç§’ï¼‰',
                            data: afterImageData,
                            borderColor: '#ff9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#ff9800',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#e7e7e7', font: { size: 14 } } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#a8b0bf' },
                                grid: { color: '#2a2f3a' }
                            },
                            x: {
                                ticks: { color: '#a8b0bf' },
                                grid: { color: '#2a2f3a' }
                            }
                        }
                    }
                });
            }

            const sharpnessCount = { 'éå¸¸ã«é®®æ˜': 0, 'ä¸­ç¨‹åº¦': 0, 'ã‹ã™ã‹': 0 };
            sessions.forEach(s => {
                const text = ['', 'ã‹ã™ã‹', 'ä¸­ç¨‹åº¦', 'éå¸¸ã«é®®æ˜'][s.sharpness];
                if (sharpnessCount.hasOwnProperty(text)) sharpnessCount[text]++;
            });

            const ctx2 = document.getElementById('sharpnessChart').getContext('2d');
            if (sharpnessChartInstance) {
                sharpnessChartInstance.data.datasets[0].data = [sharpnessCount['éå¸¸ã«é®®æ˜'], sharpnessCount['ä¸­ç¨‹åº¦'], sharpnessCount['ã‹ã™ã‹']];
                sharpnessChartInstance.update();
            } else {
                sharpnessChartInstance = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['éå¸¸ã«é®®æ˜', 'ä¸­ç¨‹åº¦', 'ã‹ã™ã‹'],
                        datasets: [{
                            data: [sharpnessCount['éå¸¸ã«é®®æ˜'], sharpnessCount['ä¸­ç¨‹åº¦'], sharpnessCount['ã‹ã™ã‹']],
                            backgroundColor: ['#2e7d32', '#ffb300', '#e53935'],
                            borderColor: '#171a21',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { labels: { color: '#e7e7e7', font: { size: 12 } } } }
                    }
                });
            }
        }

        function handleBackupClick() {
            if (sessions.length === 0) {
                alert('ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const data = {
                appVersion: 'v8.1',
                exportDate: new Date().toISOString(),
                totalSessions: sessions.length,
                sessions: sessions
            };

            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `orange-card-backup-${timestamp}.json`;

            try {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 100);
                alert(`${sessions.length}ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
            } catch (e) {
                console.error('v8.1 Backup error', e);
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const importFile = document.getElementById('importFile');
            if (importFile) {
                importFile.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.sessions && Array.isArray(data.sessions)) {
                                sessions = data.sessions;
                                localStorage.setItem('orangeCardSessions', JSON.stringify(sessions));
                                refreshDashboard();
                                alert(`${sessions.length}ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
                            } else {
                                alert('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
                            }
                        } catch (err) {
                            console.error('v8.1 Import error', err);
                            alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼');
                        }
                    };
                    reader.readAsText(file);
                    this.value = '';
                };
            }
        });

        function handleDeleteClick() {
            if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰')) {
                try {
                    sessions = [];
                    localStorage.removeItem('orangeCardSessions');
                    refreshDashboard();
                    alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } catch (e) {
                    console.error('v8.1 Delete error', e);
                    alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼');
                }
            }
        }

        function loadSessions() {
            const stored = localStorage.getItem('orangeCardSessions');
            if (stored) {
                try {
                    sessions = JSON.parse(stored);
                } catch (e) {
                    console.warn('v8.1 Parse error', e);
                    sessions = [];
                }
            }
        }
    </script>
</body>
</html>
